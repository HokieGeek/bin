#!/bin/sh

threshold=1
terminal="xterm"
mfu_file="$HOME/.dmenu_run_mfu"
[ ! -f ${mfu_file} ] && touch ${mfu_file}

while [ $# -gt 0 ]; do
    case $1 in
    --threshold) shift; threshold=$1 ;;
    --terminal) shift; terminal=$1 ;;
    *) dmenu_args="${dmenu_args}$1 " ;;
    esac
    shift
done

dmenu_path \
| awk -v threshold=${threshold} '
    FILENAME == "-" && !($0 in mfu) {
        print
        next
    }
    $1 > threshold {
        $1 = ""
        $2 = ""
        gsub(/^[ \t]*|[ \t]*$/, "")
        if (length($0)) {
            mfu[$0]=0
            print
        }
    }
' ${mfu_file} - \
| dmenu $dmenu_args \
| awk -v shell=${SHELL:-"/bin/sh"} -v terminal=${terminal} '
    BEGIN {
        ageOut = strftime("%s")-((86400 * 7) * 8) # 2 months
    }
    FILENAME == "-" && NF > 0 {
        sel = $0
        if (/#$/) {
            sub(/#$/, "")
            system(sprintf("%s -e \"%s\"&", terminal, $0))
        } else {
            print | shell
            close(shell)
        }
        next
    }
    $2 <= ageOut {
        next
    }
    NF > 2 {
        cmd = ""
        for (i = NF; i >= 3; i--) {
            cmd=$i" "cmd
        }
        sub(/ *$/, "", cmd)

        mfu[cmd] = $1
        mfu_ts[cmd] = $2
    }
    END {
        if (length(sel)) {
            mfu[sel]++
            mfu_ts[sel] = strftime("%s")
        }

        for (cmd in mfu) {
            mfu_out = sprintf("%s%s %s %s\n", mfu_out, mfu[cmd], mfu_ts[cmd], cmd)
        }
        print mfu_out | sprintf("sort -gr > %s", FILENAME)
    }
' - ${mfu_file} &
