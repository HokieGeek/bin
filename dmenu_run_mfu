#!/bin/bash

threshold=1
list="$HOME/.dmenu_run_mfu"
[ ! -f "${list}" ] && touch "${list}"

dmenu_path | awk -v threshold=${threshold} -v mfu_file=${list} '
BEGIN {
    while((getline < mfu_file) > 0) {
        if ($1 > threshold) {
            mfu[$3] = $1
            print $3
        }
    }
    close(mfu_file)
}
!($0 in mfu) {
    print
}
' \
| dmenu "$@" \
| awk -v shell=${SHELL:-"/bin/sh"} -v terminal="st" '
BEGIN {
    ageOut = strftime("%s")-((86400 * 7) * 8)
}
FILENAME == "-" {
    sel = $0
    sub("#$", "", $1)
    sel_cmd = $1
    next
}
$2 <= ageOut {
    next
}
$0 !~ /^ *$/ {
    mfu[$3] = $1
    if (sel_cmd == $3) {
        mfu[$3]++
        mfu_timestamp[$3] = strftime("%s")
    } else {
        mfu_timestamp[$3] = $2
    }
}
END {
    if (length(sel_cmd) > 0 && sel_cmd !~ "^ *$") {
        if (!(sel_cmd in mfu)) {
            mfu[sel_cmd] = 1
            mfu_timestamp[sel_cmd] = strftime("%s")
        }
    }
    for (cmd in mfu) {
        mfu_out = sprintf( "%s%s %s %s\n", mfu_out, mfu[cmd], mfu_timestamp[cmd], cmd)
    }
    new_mfu = sprintf("sort -gr > %s", FILENAME)
    print mfu_out | new_mfu
    close(new_mfu)

    if (substr(sel, length(sel), 1) == "#") {
        sub("#$", "", sel)
        system(sprintf("%s -e \"%s\"", terminal, sel))
    } else {
        print sel | shell
        close(shell)
    }
}
' - ${list} &
